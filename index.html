<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YouTube Video Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(120deg, #A50000, #FFD700); color: #333; }
    h1, p { color: white; }
    body.dark-mode { background: #1a1a2e; color: #f5f5f5; }
    body.dark-mode input, body.dark-mode select { background-color: whitesmoke; color: black; }
    body.dark-mode .video-card { background-color: #282828; color: #f5f5f5; }
    body.dark-mode select option { color: black; }
    .video-thumbnail:hover { transform: scale(1.03); }

    #videoModal {
      position: fixed;
      cursor: move;
      touch-action: none;
      user-select: none;
      z-index: 9999 !important;
      transition: all 0.3s ease-in-out;
    }

    @media (max-width: 640px) {
      .mobile-controls { flex-direction: row; justify-content: center; gap: 0.75rem; }
      #historyPanel {
        width: 100%;
        max-width: 90%;
      }
    }
  </style>
</head>
<body class="min-h-screen">

<!-- ‚úÖ History Button -->
<button id="historyToggle" onclick="toggleHistoryPanel()" class="fixed top-4 right-4 z-50 bg-yellow-500 hover:bg-yellow-600 text-black font-semibold px-3 py-1 rounded text-sm">History</button>

<!-- ‚úÖ History Panel -->
<div id="historyPanel" class="fixed top-0 right-0 w-72 h-full bg-white dark-mode:bg-gray-800 text-black dark-mode:text-white shadow-lg transform translate-x-full transition-transform duration-300 z-40 overflow-y-auto overscroll-contain">
  <div class="flex justify-between items-center px-4 py-2 border-b border-gray-300">
    <h2 class="text-lg font-semibold">Search History</h2>
    <button onclick="clearHistory()" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">Clear</button>
  </div>
  <div id="historyList" class="p-4 text-sm space-y-4"></div>
</div>

<div class="container mx-auto px-4 py-8">
  <header class="mb-8 text-center relative">
    <h1 class="text-3xl font-bold mb-2">YouTube Video Search</h1>
    <p class="text-white-500">Search for videos without distractions</p>
  </header>

  <div class="max-w-2xl mx-auto mb-4">
    <div class="flex">
      <input type="text" id="searchInput" placeholder="Search for videos..." class="w-full px-4 py-3 rounded-l-lg border-2 border-gray-300">
      <button id="searchButton" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-r-lg">Search</button>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6 mobile-controls">
    <button id="nightModeToggle" class="w-10 h-10 flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-full text-xl">üåô</button>
    <label for="sortSelect" class="text-white font-medium">Sort by:</label>
    <select id="sortSelect" class="px-4 py-2 rounded border border-gray-300">
      <option value="relevance">Relevance</option>
      <option value="viewCount">Views</option>
      <option value="date">Latest</option>
      <option value="likes">Likes</option>
      <option value="channel">Channel A‚ÄëZ</option>
    </select>
  </div>

  <div id="videoResults" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

  <div id="loadMoreContainer" class="text-center mt-8">
    <button id="loadMoreButton" class="bg-gray-800 hover:bg-black text-white px-6 py-3 rounded-lg hidden">Load More</button>
  </div>
</div>

<script>
const API_KEYS = [
  'AIzaSyD4C8Sdj0vIJkpPwFpnDeQKzme_JuDQg3o',
  'AIzaSyBYWdAvKHDJcj5X-VBc-Ob4tKepRx9IAk8',
  'AIzaSyBAXzH-FPMCNgbC6skfqP0scZREjALh4u0',
  'AIzaSyAwtPbKNBMdL8jtWYqnEfDdXIrrzV20D8s'
];
let currentApiIndex = 0, nextPageToken = '', currentQuery = '', currentSort = 'relevance';
let videoList = [], currentVideoIndex = -1, isAutoPlayOn = false, isMinimized = false, ytPlayer = null;

const videoResults = document.getElementById("videoResults");
const searchInput = document.getElementById("searchInput");
const searchButton = document.getElementById("searchButton");
const loadMoreButton = document.getElementById("loadMoreButton");
const nightModeToggle = document.getElementById("nightModeToggle");

function createVideoCard(video, index) {
  const { videoId } = video.id;
  const { title, thumbnails, publishedAt, channelTitle } = video.snippet;
  const likes = video.statistics?.likeCount || '‚Äî';
  return `
    <div class="video-card bg-white rounded-lg shadow-md">
      <div class="video-thumbnail relative">
        <img src="${thumbnails.medium.url}" alt="${title}" class="w-full h-48 object-cover" onclick="openVideoModal('${videoId}', ${index}, '${escapeHtml(title)}')">
      </div>
      <div class="p-4">
        <h3 class="font-medium text-lg mb-1">${title}</h3>
        <p class="text-sm text-gray-600">${new Date(publishedAt).toLocaleDateString()}</p>
        <p class="text-sm text-gray-600">Channel: ${channelTitle}</p>
        <p class="text-sm text-gray-600">Likes: ${likes}</p>
      </div>
    </div>`;
}

function escapeHtml(str) {
  return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function renderVideos(videos) {
  videos.forEach((v, i) => videoResults.insertAdjacentHTML("beforeend", createVideoCard(v, i)));
}

function clearResults() {
  videoResults.innerHTML = '';
  nextPageToken = '';
  videoList = [];
  currentVideoIndex = -1;
}

async function fetchVideos(query, token = '', retry = 0) {
  const apiKey = API_KEYS[currentApiIndex];
  const orderParam = ['likes','channel'].includes(currentSort) ? 'relevance' : currentSort;
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=12&order=${orderParam}&pageToken=${token}&key=${apiKey}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const ids = data.items.map(i => i.id.videoId).join(',');
    const statsRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${ids}&key=${apiKey}`);
    if (!statsRes.ok) throw new Error('Stats fetch failed');
    const statsData = await statsRes.json();
    data.items.forEach((item, i) => item.statistics = statsData.items[i]?.statistics || {});
    videoList = data.items;

    if (currentSort === "likes")
      videoList.sort((a, b) => (b.statistics.likeCount || 0) - (a.statistics.likeCount || 0));
    if (currentSort === "channel")
      videoList.sort((a, b) => a.snippet.channelTitle.localeCompare(b.snippet.channelTitle));

    renderVideos(videoList);
    nextPageToken = data.nextPageToken || '';
    if (nextPageToken) loadMoreButton.classList.remove('hidden');
  } catch (err) {
    console.error(`API key #${currentApiIndex + 1} failed: ${err.message}`);
    currentApiIndex = (currentApiIndex + 1) % API_KEYS.length;
    if (retry < API_KEYS.length - 1) await fetchVideos(query, token, retry + 1);
    else alert("All API keys failed.");
  }
}

function handleSearch() {
  const query = searchInput.value.trim(); if (!query) return;
  currentQuery = query;
  clearResults();
  fetchVideos(query);
  saveSearchQuery(query);
}

searchButton.onclick = handleSearch;
searchInput.onkeypress = e => { if (e.key === 'Enter') handleSearch(); };
loadMoreButton.onclick = () => fetchVideos(currentQuery, nextPageToken);
document.getElementById("sortSelect").onchange = function () { currentSort = this.value; handleSearch(); };

nightModeToggle.onclick = () => {
  document.body.classList.toggle("dark-mode");
  const isDark = document.body.classList.contains("dark-mode");
  localStorage.setItem("darkMode", isDark);
  nightModeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
};
if (localStorage.getItem("darkMode") === "true") {
  document.body.classList.add("dark-mode");
  nightModeToggle.textContent = "‚òÄÔ∏è";
}

function onYouTubeIframeAPIReady() {}

function openVideoModal(videoId, index = -1, title = '') {
  closeVideoModal();
  currentVideoIndex = index; isMinimized = false;
  saveVideoToHistory(currentQuery, title, videoId);
  const modal = document.createElement("div");
  modal.id = "videoModal";
  modal.className = "w-80 h-60 bg-black rounded-lg overflow-hidden shadow-xl";
  modal.style.top = "20px";
  modal.style.left = "20px";
  modal.style.position = "fixed";
  modal.innerHTML = `
    <div class="absolute top-1 right-1 flex gap-1 z-10">
      <button onclick="toggleAutoplay()" id="autoplayBtn" class="text-white bg-blue-600 hover:bg-blue-700 rounded px-2 py-1 text-xs">${isAutoPlayOn ? 'üîÅ On' : 'üîÅ Off'}</button>
      <button onclick="toggleMinimize()" class="text-white bg-green-600 hover:bg-green-700 rounded px-2 py-1 text-xs">üóï</button>
      <button onclick="closeVideoModal()" class="text-white bg-red-600 hover:bg-red-700 rounded px-2 py-1 text-xs">‚úï</button>
    </div>
    <div id="player" class="w-full"></div>
    <div class="flex justify-between items-center px-2 py-1 bg-gray-900 text-white text-xs absolute bottom-0 w-full z-20">
      <button onclick="playPrevVideo()" class="bg-gray-700 hover:bg-gray-800 rounded px-2 py-1">‚èÆ Prev</button>
      <span>Now Playing</span>
      <button onclick="playNextVideo()" class="bg-gray-700 hover:bg-gray-800 rounded px-2 py-1">Next ‚è≠</button>
    </div>`;
  document.body.appendChild(modal);
  makeDraggable(modal);
  ytPlayer = new YT.Player('player', { height: '100%', width: '100%', videoId, playerVars: { autoplay: 1, rel: 0 }, events: { 'onStateChange': onPlayerStateChange } });
}

function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.ENDED && isAutoPlayOn) playNextVideo();
}
function closeVideoModal() { document.getElementById("videoModal")?.remove(); }
function playNextVideo() { if (currentVideoIndex < videoList.length - 1) openVideoModal(videoList[++currentVideoIndex].id.videoId, currentVideoIndex, videoList[currentVideoIndex].snippet.title); }
function playPrevVideo() { if (currentVideoIndex > 0) openVideoModal(videoList[--currentVideoIndex].id.videoId, currentVideoIndex, videoList[currentVideoIndex].snippet.title); }
function toggleAutoplay() { isAutoPlayOn = !isAutoPlayOn; document.getElementById("autoplayBtn").textContent = isAutoPlayOn ? "üîÅ On" : "üîÅ Off"; }

function toggleMinimize() {
  const modal = document.getElementById("videoModal"), player = document.getElementById("player");
  if (!modal || !player) return;
  isMinimized = !isMinimized;
  if (isMinimized) {
    modal.style.width = "220px"; modal.style.height = "160px"; player.style.height = "100px";
  } else {
    modal.style.width = "360px"; modal.style.height = "280px"; player.style.height = "180px";
  }
}

function makeDraggable(el) {
  let offsetX = 0, offsetY = 0, isDragging = false;
  el.addEventListener("mousedown", e => {
    isDragging = true;
    offsetX = e.clientX - el.offsetLeft;
    offsetY = e.clientY - el.offsetTop;
    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
  });
  function onMouseMove(e) {
    if (!isDragging) return;
    el.style.left = `${e.clientX - offsetX}px`;
    el.style.top = `${e.clientY - offsetY}px`;
    el.style.bottom = el.style.right = '';
  }
  function onMouseUp() {
    isDragging = false;
    document.removeEventListener("mousemove", onMouseMove);
    document.removeEventListener("mouseup", onMouseUp);
  }
  el.addEventListener("touchstart", e => {
    isDragging = true;
    const touch = e.touches[0];
    offsetX = touch.clientX - el.offsetLeft;
    offsetY = touch.clientY - el.offsetTop;
    document.addEventListener("touchmove", onTouchMove, { passive: false });
    document.addEventListener("touchend", onTouchEnd);
  });
  function onTouchMove(e) {
    if (!isDragging) return;
    const touch = e.touches[0];
    el.style.left = `${touch.clientX - offsetX}px`;
    el.style.top = `${touch.clientY - offsetY}px`;
    el.style.bottom = el.style.right = '';
    e.preventDefault();
  }
  function onTouchEnd() {
    isDragging = false;
    document.removeEventListener("touchmove", onTouchMove);
    document.removeEventListener("touchend", onTouchEnd);
  }
}

document.onkeydown = e => {
  if (e.key === "ArrowRight") playNextVideo();
  if (e.key === "ArrowLeft") playPrevVideo();
  if (e.key === "Escape") {
    document.getElementById("historyPanel").classList.add("translate-x-full");
    document.getElementById("historyToggle").style.display = "block";
  }
};

// ‚úÖ History Functions
function toggleHistoryPanel() {
  const panel = document.getElementById("historyPanel");
  panel.classList.toggle("translate-x-full");
  document.getElementById("historyToggle").style.display = panel.classList.contains("translate-x-full") ? "block" : "none";
}

function saveSearchQuery(query) {
  let history = JSON.parse(localStorage.getItem("searchHistory")) || {};
  if (!history[query]) history[query] = [];
  const keys = Object.keys(history);
  if (keys.length > 10) delete history[keys[0]];
  localStorage.setItem("searchHistory", JSON.stringify(history));
  renderHistory();
}

function saveVideoToHistory(query, title, videoId) {
  let history = JSON.parse(localStorage.getItem("searchHistory")) || {};
  if (!history[query]) history[query] = [];
  if (!history[query].some(v => v.videoId === videoId)) {
    history[query].push({ title, videoId });
    localStorage.setItem("searchHistory", JSON.stringify(history));
    renderHistory();
  }
}

function renderHistory() {
  const container = document.getElementById("historyList");
  const history = JSON.parse(localStorage.getItem("searchHistory")) || {};
  container.innerHTML = Object.entries(history).reverse().map(([query, videos]) => {
    const videoList = videos.map(v => `<li class="ml-4 text-blue-600 underline cursor-pointer" onclick="openVideoModal('${v.videoId}', -1, '${escapeHtml(v.title)}')">${v.title}</li>`).join("");
    return `<div><h3 class="font-semibold">${query}</h3><ul class="list-disc">${videoList}</ul></div>`;
  }).join("");
}

function clearHistory() {
  localStorage.removeItem("searchHistory");
  renderHistory();
}

renderHistory();

// ‚úÖ Auto-close history panel
document.addEventListener("click", (e) => {
  const panel = document.getElementById("historyPanel");
  const toggleBtn = document.getElementById("historyToggle");
  if (!panel.classList.contains("translate-x-full") &&
      !panel.contains(e.target) &&
      !toggleBtn.contains(e.target)) {
    panel.classList.add("translate-x-full");
    toggleBtn.style.display = "block";
  }
});

document.getElementById("historyPanel").addEventListener("mouseleave", () => {
  if (window.innerWidth >= 768) {
    document.getElementById("historyPanel").classList.add("translate-x-full");
    document.getElementById("historyToggle").style.display = "block";
  }
});
</script>

</body>
</html>
